<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.0.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Removed OKLCH colors to fix loading issue
                    },
                    borderRadius: {
                        DEFAULT: 'var(--radius)',
                        sm: 'calc(var(--radius) - 0.125rem)',
                        md: 'calc(var(--radius) - 0.0625rem)',
                        lg: 'var(--radius)',
                        xl: 'calc(var(--radius) + 0.125rem)'
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --background: 0.9659 0.0080 286.2495;
            --foreground: 0.2621 0.0095 248.1897;
            --card: 0.9843 0.0024 238.4651;
            --card-foreground: 0.2621 0.0095 248.1897;
            --primary: 0.6872 0.1242 179.0797;
            --primary-foreground: 0.9843 0.0024 238.4651;
            --secondary: 0.9388 0.0025 228.7854;
            --secondary-foreground: 0.2621 0.0095 248.1897;
            --muted: 0.9388 0.0025 228.7854;
            --muted-foreground: 0.4961 0.0060 239.8949;
            --accent: 0.9388 0.0025 228.7854;
            --accent-foreground: 0.2621 0.0095 248.1897;
            --destructive: 0.6763 0.1777 33.4552;
            --destructive-foreground: 0.9843 0.0024 238.4651;
            --border: 0.9388 0.0025 228.7854;
            --input: 0.9388 0.0025 228.7854;
            --ring: 0.6872 0.1242 179.0797;
            --radius: 0.4rem;
        }

        .dark {
            --background: 0.2077 0.0398 265.7549;
            --foreground: 0.9288 0.0126 255.5078;
            --card: 0.2077 0.0398 265.7549;
            --card-foreground: 0.9288 0.0126 255.5078;
            --primary: 0.6872 0.1242 179.0797;
            --primary-foreground: 0.1551 0.0209 229.8235;
            --secondary: 0.3061 0.0396 263.7216;
            --secondary-foreground: 0.9288 0.0126 255.5078;
            --muted: 0.3061 0.0396 263.7216;
            --muted-foreground: 0.7216 0.0115 256.8412;
            --accent: 0.3061 0.0396 263.7216;
            --accent-foreground: 0.9288 0.0126 255.5078;
            --destructive: 0.6372 0.1687 27.3292;
            --destructive-foreground: 0.9288 0.0126 255.5078;
            --border: 0.3061 0.0396 263.7216;
            --input: 0.3061 0.0396 263.7216;
            --ring: 0.6872 0.1242 179.0797;
        }

        /* Component Classes */
        .card {
            background-color: #ffffff;
            color: #1f2937;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
        }

        .btn-primary {
            background-color: oklch(var(--primary));
            color: oklch(var(--primary-foreground));
            border-radius: var(--radius);
            transition: all 0.2s ease-in-out;
        }


        .btn-secondary {
            background-color: oklch(var(--secondary));
            color: oklch(var(--secondary-foreground));
            border-radius: var(--radius);
            transition: all 0.2s ease-in-out;
        }

        .btn-secondary:hover {
            background-color: oklch(calc(var(--secondary) - 0.05));
        }

        .btn-destructive {
            background-color: oklch(var(--destructive));
            color: oklch(var(--destructive-foreground));
            border-radius: var(--radius);
            transition: all 0.2s ease-in-out;
        }

        .btn-destructive:hover {
            background-color: oklch(calc(var(--destructive) - 0.05));
        }
        
        /* Extract System Control Buttons */
        .extract-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            white-space: nowrap;
            border-radius: calc(var(--radius) - 2px);
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.25rem;
            height: 2.5rem;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
            outline: none;
        }
        
        .extract-btn:focus-visible {
            outline: 2px solid oklch(var(--ring));
            outline-offset: 2px;
        }
        
        .extract-btn:disabled {
            pointer-events: none;
            opacity: 0.5;
        }
        
        .extract-btn-primary {
            background-color: oklch(var(--primary));
            color: oklch(var(--primary-foreground));
        }
        
        .extract-btn-primary:hover:not(:disabled) {
            background-color: oklch(calc(var(--primary) - 0.05));
        }
        
        .extract-btn-destructive {
            background-color: oklch(var(--destructive));
            color: oklch(var(--destructive-foreground));
        }
        
        .extract-btn-destructive:hover:not(:disabled) {
            background-color: oklch(calc(var(--destructive) - 0.05));
        }
        
        .extract-btn-loading {
            background-color: oklch(var(--muted));
            color: oklch(var(--muted-foreground));
            cursor: not-allowed;
        }

        .tab-active {
            background-color: oklch(var(--primary));
            color: oklch(var(--primary-foreground));
        }

        .tab-inactive {
            background-color: transparent;
            color: oklch(var(--muted-foreground));
        }

        .tab-inactive:hover {
            background-color: oklch(var(--muted));
            color: oklch(var(--muted-foreground));
        }

        .status-connected {
            color: oklch(0.6872 0.1242 179.0797);
        }

        .status-error {
            color: oklch(var(--destructive));
        }

        .status-connecting {
            color: oklch(var(--muted-foreground));
        }

        /* Animation utilities */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse-slow {
            animation: pulse 2s infinite;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            min-width: 320px;
            max-width: 480px;
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }

        .notification-success {
            background-color: oklch(0.8784 0.0706 161.1102);
            color: oklch(0.1843 0.0433 161.6216);
            border-left: 4px solid oklch(0.6872 0.1242 179.0797);
        }

        .notification-error {
            background-color: oklch(0.9372 0.0561 34.5612);
            color: oklch(0.4318 0.1133 33.7302);
            border-left: 4px solid oklch(var(--destructive));
        }

        .notification-warning {
            background-color: oklch(0.9574 0.0681 75.3513);
            color: oklch(0.4755 0.1220 78.2145);
            border-left: 4px solid oklch(0.7451 0.1294 89.1022);
        }
        
        /* Extract API Button Styles - Fixed without OKLCH */
        .extract-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            border: none;
        }
        
        .extract-btn-primary {
            background-color: #3b82f6 !important;
            color: #ffffff !important;
        }
        
        .extract-btn-primary:hover {
            background-color: #2563eb !important;
        }
        
        .extract-btn-destructive {
            background-color: #ef4444 !important;
            color: #ffffff !important;
        }
        
        .extract-btn-destructive:hover {
            background-color: #dc2626 !important;
        }
        
        .extract-btn-loading {
            background-color: #6b7280 !important;
            color: #ffffff !important;
            cursor: not-allowed;
        }
        
        /* Articles Table Filter Dropdowns Fix */
        #source-filter-dropdown,
        #date-filter-dropdown,
        #status-filter-dropdown {
            position: absolute;
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Table headers positioning fix */
        #articles-tab th {
            position: relative;
        }
        
        /* Filter button hover fix */
        #articles-tab th button {
            background-color: transparent;
            transition: background-color 0.2s;
        }
        
        #articles-tab th button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        /* Table layout fix */
        #articles-tab table {
            table-layout: auto;
        }
        
        /* Column widths for proper alignment */
        #articles-tab th:nth-child(1) { width: 35%; } /* Title */
        #articles-tab th:nth-child(2) { width: 15%; } /* Source */
        #articles-tab th:nth-child(3) { width: 15%; } /* Date */
        #articles-tab th:nth-child(4) { width: 10%; } /* URL */
        #articles-tab th:nth-child(5) { width: 10%; } /* Media */
        #articles-tab th:nth-child(6) { width: 15%; } /* Status */
    </style>
</head>
<body class="min-h-screen" style="background-color: oklch(var(--background)); color: oklch(var(--foreground));">
    <!-- Header -->
    <header class="card border-0 border-b rounded-none sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <!-- Logo and Title -->
                <div class="flex items-center space-x-3">
                    <div class="p-2 rounded-lg" style="background-color: oklch(var(--primary));">
                        <i class="ri-dashboard-3-line text-xl" style="color: oklch(var(--primary-foreground));"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold" style="color: oklch(var(--foreground));">AI News Control Center</h1>
                        <p class="text-sm" style="color: oklch(var(--muted-foreground));">Monitoring & Control Dashboard</p>
                    </div>
                </div>

                <!-- Status and Controls -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 rounded-full status-connecting pulse-slow" id="connection-indicator"></div>
                        <span class="text-sm font-medium status-connecting" id="connection-status">Connecting...</span>
                    </div>
                    <div class="text-sm" style="color: oklch(var(--muted-foreground));">
                        Last update: <span id="last-update">--:--</span>
                    </div>
                    <button onclick="refreshDashboard()" class="btn-secondary px-3 py-2 text-sm flex items-center space-x-2" aria-label="Refresh Dashboard">
                        <i class="ri-refresh-line"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Notification Container -->
        <div id="notification-container" aria-live="polite" aria-atomic="true"></div>

        <!-- Navigation Tabs -->
        <nav class="card p-1 mb-6" role="tablist" aria-label="Dashboard sections">
            <div class="flex space-x-1">
                <button 
                    onclick="switchTab('control')" 
                    class="tab-button tab-active px-4 py-2 text-sm font-medium rounded-md flex items-center space-x-2 transition-all duration-200"
                    role="tab"
                    aria-selected="true"
                    aria-controls="control-tab"
                    id="control-tab-button"
                >
                    <i class="ri-play-circle-line text-lg"></i>
                    <span>Control</span>
                </button>
                <button 
                    onclick="switchTab('articles')" 
                    class="tab-button tab-inactive px-4 py-2 text-sm font-medium rounded-md flex items-center space-x-2 transition-all duration-200"
                    role="tab"
                    aria-selected="false"
                    aria-controls="articles-tab"
                    id="articles-tab-button"
                >
                    <i class="ri-article-line text-lg"></i>
                    <span>Articles</span>
                </button>
                <button 
                    onclick="switchTab('memory')" 
                    class="tab-button tab-inactive px-4 py-2 text-sm font-medium rounded-md flex items-center space-x-2 transition-all duration-200"
                    role="tab"
                    aria-selected="false"
                    aria-controls="memory-tab"
                    id="memory-tab-button"
                >
                    <i class="ri-cpu-line text-lg"></i>
                    <span>Memory</span>
                </button>
                <button 
                    onclick="switchTab('rss')" 
                    class="tab-button tab-inactive px-4 py-2 text-sm font-medium rounded-md flex items-center space-x-2 transition-all duration-200"
                    role="tab"
                    aria-selected="false"
                    aria-controls="rss-tab"
                    id="rss-tab-button"
                >
                    <i class="ri-rss-line text-lg"></i>
                    <span>RSS Feeds</span>
                </button>
                <button 
                    onclick="switchTab('errors')" 
                    class="tab-button tab-inactive px-4 py-2 text-sm font-medium rounded-md flex items-center space-x-2 transition-all duration-200"
                    role="tab"
                    aria-selected="false"
                    aria-controls="errors-tab"
                    id="errors-tab-button"
                >
                    <i class="ri-error-warning-line text-lg"></i>
                    <span>Errors</span>
                </button>
            </div>
        </nav>

        <!-- Tab Content Container -->
        <div id="tab-content" class="fade-in">
            <!-- Control Tab -->
            <div id="control-tab" class="tab-content" role="tabpanel" aria-labelledby="control-tab-button">
                <div class="space-y-6">
                    <!-- Control Panel -->
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h2 class="text-lg font-semibold" style="color: oklch(var(--foreground));">Parser Control</h2>
                                <p class="text-sm" style="color: oklch(var(--muted-foreground));">Start, stop, and configure the AI news parsing system</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="text-sm" style="color: oklch(var(--muted-foreground));">Status:</div>
                                <span id="parser-status" class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">Unknown</span>
                            </div>
                        </div>

                        <!-- Control Buttons -->
                        <div class="flex flex-wrap gap-3 mb-6">
                            <button id="rss-toggle" class="extract-btn extract-btn-primary" onclick="toggleRSS()">
                                <i class="ri-rss-line w-4 h-4" id="rss-icon"></i>
                                <span id="rss-text">Start RSS</span>
                            </button>
                            <button id="parse-toggle" class="extract-btn extract-btn-primary" onclick="toggleParse()">
                                <i class="ri-file-text-line w-4 h-4" id="parse-icon"></i>
                                <span id="parse-text">Start Parse</span>
                            </button>
                            <button id="media-toggle" class="extract-btn extract-btn-primary" onclick="toggleMedia()">
                                <i class="ri-image-line w-4 h-4" id="media-icon"></i>
                                <span id="media-text">Start Media</span>
                            </button>
                        </div>

                        <!-- Last Parsed Configuration -->
                        <div class="mb-6 p-4 rounded-lg" style="background-color: oklch(var(--muted));">
                            <div class="flex items-center justify-between mb-2">
                                <label for="last-parsed" class="text-sm font-medium" style="color: oklch(var(--foreground));">Last Parsed Date/Time</label>
                                <button onclick="saveLastParsed()" class="btn-secondary px-3 py-1 text-sm">
                                    <i class="ri-save-line mr-1"></i> Save
                                </button>
                            </div>
                            <input 
                                type="datetime-local" 
                                id="last-parsed" 
                                class="w-full px-3 py-2 rounded-md" 
                                style="background-color: oklch(var(--background)); border: 1px solid oklch(var(--border)); color: oklch(var(--foreground));"
                            >
                            <p class="text-xs mt-1" style="color: oklch(var(--muted-foreground));">
                                Parser will only fetch articles newer than this timestamp
                            </p>
                        </div>
                    </div>
                    
                    <!-- Database Management -->
                    <div class="card p-6 mb-6">
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold mb-2" style="color: oklch(var(--foreground));">Database Management</h2>
                            <p class="text-sm" style="color: oklch(var(--muted-foreground));">Clean up articles by status</p>
                        </div>
                        
                        <!-- Status Statistics -->
                        <div id="db-stats" class="grid grid-cols-3 gap-4 mb-6">
                            <div class="p-4 rounded-lg" style="background-color: oklch(var(--muted)/0.3);">
                                <div class="text-sm font-medium" style="color: oklch(var(--muted-foreground));">Pending</div>
                                <div class="text-2xl font-bold" style="color: oklch(var(--foreground));" id="pending-count">-</div>
                            </div>
                            <div class="p-4 rounded-lg" style="background-color: oklch(var(--muted)/0.3);">
                                <div class="text-sm font-medium" style="color: oklch(var(--muted-foreground));">Parsed</div>
                                <div class="text-2xl font-bold" style="color: oklch(var(--foreground));" id="parsed-count">-</div>
                            </div>
                            <div class="p-4 rounded-lg" style="background-color: oklch(var(--muted)/0.3);">
                                <div class="text-sm font-medium" style="color: oklch(var(--muted-foreground));">Failed</div>
                                <div class="text-2xl font-bold" style="color: oklch(var(--foreground));" id="failed-count">-</div>
                            </div>
                        </div>
                        
                        <!-- Clean Actions -->
                        <div class="flex items-center gap-4">
                            <div class="flex-1">
                                <label for="clean-status" class="block text-sm font-medium mb-2" style="color: oklch(var(--foreground));">Select Status</label>
                                <select id="clean-status" class="w-full px-3 py-2 rounded-md border" style="background-color: oklch(var(--background)); border-color: oklch(var(--border)); color: oklch(var(--foreground));">
                                    <option value="">Choose status to clean...</option>
                                    <option value="pending">Pending</option>
                                    <option value="parsed">Parsed</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: oklch(var(--foreground));">&nbsp;</label>
                                <button 
                                    onclick="cleanDatabase()" 
                                    class="extract-btn extract-btn-destructive"
                                    id="clean-db-btn"
                                    disabled
                                >
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                    Clean Database
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Real-time Logs -->
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold" style="color: oklch(var(--foreground));">Real-time Logs</h3>
                            <div class="flex items-center space-x-2">
                                <select id="log-level-filter" class="px-3 py-1 text-sm rounded-md" style="background-color: oklch(var(--input)); border: 1px solid oklch(var(--border)); color: oklch(var(--foreground));" onchange="filterLogs()">
                                    <option value="all">All Levels</option>
                                    <option value="info">INFO</option>
                                    <option value="warning">WARNING</option>
                                    <option value="error">ERROR</option>
                                </select>
                                <button onclick="clearLogs()" class="btn-secondary px-3 py-1 text-sm">
                                    <i class="ri-delete-bin-line"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        <div id="log-container" class="rounded-lg p-4 h-96 overflow-y-auto font-mono text-sm" style="background-color: #0a0a0a; color: #00ff00;">
                            <div class="text-gray-400 text-center py-8">
                                <i class="ri-terminal-line text-2xl mb-2"></i>
                                <p>Logs will appear here when Extract system is running...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Articles Tab -->
            <div id="articles-tab" class="tab-content hidden" role="tabpanel" aria-labelledby="articles-tab-button">
                <div class="space-y-6">
                    
                    <!-- Search and Filters -->
                    <div class="card p-4">
                        <div class="flex flex-wrap gap-4">
                            <div class="flex-1 min-w-[200px]">
                                <input type="text" id="article-search" placeholder="Search articles..." 
                                       class="w-full px-3 py-2 rounded-md border"
                                       style="background-color: oklch(var(--background)); border-color: oklch(var(--border)); color: oklch(var(--foreground));">
                            </div>
                            <div class="w-48">
                                <select id="source-filter" class="w-full px-3 py-2 rounded-md border"
                                        style="background-color: oklch(var(--background)); border-color: oklch(var(--border)); color: oklch(var(--foreground));">
                                    <option value="">All Sources</option>
                                </select>
                            </div>
                            <div class="w-48">
                                <select id="date-filter" class="w-full px-3 py-2 rounded-md border"
                                        style="background-color: oklch(var(--background)); border-color: oklch(var(--border)); color: oklch(var(--foreground));">
                                    <option value="">All Dates</option>
                                    <option value="24h">Last 24 hours</option>
                                    <option value="7d">Last 7 days</option>
                                    <option value="30d">Last 30 days</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Articles Table -->
                    <div class="card p-0 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead style="background-color: oklch(var(--muted));">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-medium w-2/5" style="color: oklch(var(--muted-foreground));">Title</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium relative w-1/6" style="color: oklch(var(--muted-foreground));">
                                            <div class="flex items-center justify-between">
                                                <span>Source</span>
                                                <button id="source-filter-btn" onclick="toggleSourceFilter()" class="ml-2 p-1 hover:bg-gray-200 rounded">
                                                    <i class="ri-filter-line text-xs"></i>
                                                </button>
                                            </div>
                                            <!-- Source Filter Dropdown -->
                                            <div id="source-filter-dropdown" class="absolute top-full left-0 mt-1 w-64 bg-white border rounded-lg shadow-lg z-50 hidden">
                                                <div class="p-2 border-b">
                                                    <input type="text" id="source-search" placeholder="Search sources..." class="w-full px-2 py-1 text-sm border rounded">
                                                </div>
                                                <div class="max-h-48 overflow-y-auto" id="source-filter-options">
                                                    <div class="p-2 text-sm text-gray-500">Loading sources...</div>
                                                </div>
                                            </div>
                                        </th>
                                        <th class="px-4 py-3 text-left text-sm font-medium relative w-1/6" style="color: oklch(var(--muted-foreground));">
                                            <div class="flex items-center justify-between">
                                                <span>Date</span>
                                                <button id="date-filter-btn" onclick="toggleDateFilter()" class="ml-2 p-1 hover:bg-gray-200 rounded">
                                                    <i class="ri-filter-line text-xs"></i>
                                                </button>
                                            </div>
                                            <!-- Date Filter Dropdown -->
                                            <div id="date-filter-dropdown" class="absolute top-full left-0 mt-1 w-48 bg-white border rounded-lg shadow-lg z-50 hidden">
                                                <div class="max-h-48 overflow-y-auto" id="date-filter-options">
                                                    <div class="p-2 text-sm text-gray-500">Loading dates...</div>
                                                </div>
                                            </div>
                                        </th>
                                        <th class="px-4 py-3 text-left text-sm font-medium w-16" style="color: oklch(var(--muted-foreground));">URL</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium w-20" style="color: oklch(var(--muted-foreground));">Media</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium relative w-1/6" style="color: oklch(var(--muted-foreground));">
                                            <div class="flex items-center justify-between">
                                                <span>Status</span>
                                                <button id="status-filter-btn" onclick="toggleStatusFilter()" class="ml-2 p-1 hover:bg-gray-200 rounded">
                                                    <i class="ri-filter-line text-xs"></i>
                                                </button>
                                            </div>
                                            <!-- Status Filter Dropdown -->
                                            <div id="status-filter-dropdown" class="absolute top-full left-0 mt-1 w-48 bg-white border rounded-lg shadow-lg z-50 hidden">
                                                <div class="max-h-48 overflow-y-auto" id="status-filter-options">
                                                    <div class="p-2 text-sm text-gray-500">Loading statuses...</div>
                                                </div>
                                            </div>
                                        </th>
                                        <th class="px-4 py-3 text-center text-sm font-medium w-16" style="color: oklch(var(--muted-foreground));">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="articles-table-body" class="divide-y" style="border-color: oklch(var(--border));">
                                    <tr>
                                        <td colspan="7" class="px-4 py-8 text-center text-sm" style="color: oklch(var(--muted-foreground));">Loading articles...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination Controls -->
                        <div id="articles-pagination" class="flex items-center justify-between px-4 py-3 border-t" style="border-color: oklch(var(--border));">
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));">
                                <span id="articles-pagination-info">Showing 0 of 0 articles</span>
                            </div>
                            <div class="flex space-x-2">
                                <button id="articles-prev-btn" onclick="loadArticlesPage('prev')" 
                                        class="btn-secondary px-3 py-2 text-sm" disabled>
                                    <i class="ri-arrow-left-line"></i> Previous
                                </button>
                                <span id="articles-page-info" class="px-3 py-2 text-sm" style="color: oklch(var(--foreground));">
                                    Page 1 of 1
                                </span>
                                <button id="articles-next-btn" onclick="loadArticlesPage('next')" 
                                        class="btn-secondary px-3 py-2 text-sm" disabled>
                                    Next <i class="ri-arrow-right-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Memory Tab -->
            <div id="memory-tab" class="tab-content hidden" role="tabpanel" aria-labelledby="memory-tab-button">
                <div class="space-y-6">
                    <!-- System Resources Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="card p-6 text-center">
                            <div class="text-2xl font-bold" style="color: oklch(var(--primary));" id="cpu-usage">-</div>
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));">CPU Usage</div>
                            <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                                <div id="cpu-progress" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="card p-6 text-center">
                            <div class="text-2xl font-bold" style="color: oklch(var(--primary));" id="memory-usage">-</div>
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));">AI News Memory</div>
                            <div class="text-xs mt-1" style="color: oklch(var(--muted-foreground));">System consumption in MB</div>
                        </div>
                        <div class="card p-6 text-center">
                            <div class="text-2xl font-bold" style="color: oklch(var(--foreground));" id="total-processes">-</div>
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));">AI News Processes</div>
                            <div class="text-xs mt-1" style="color: oklch(var(--muted-foreground));">Active parsing processes</div>
                        </div>
                        <div class="card p-6 text-center">
                            <div class="text-2xl font-bold" style="color: oklch(var(--primary));" id="disk-usage">-</div>
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));">Disk Usage</div>
                            <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                                <div id="disk-progress" class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resource Alerts -->
                    <div id="resource-alerts" class="card p-4 mb-4" style="display: none; background-color: oklch(var(--destructive)/0.1); border-color: oklch(var(--destructive));">
                        <div class="flex items-start">
                            <i class="ri-alert-line text-xl mr-3" style="color: oklch(var(--destructive));"></i>
                            <div id="alert-messages" class="text-sm" style="color: oklch(var(--destructive));"></div>
                        </div>
                    </div>

                    <!-- Process Manager -->
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold" style="color: oklch(var(--foreground));">AI News Process Manager</h3>
                                <p class="text-sm mt-1" style="color: oklch(var(--muted-foreground));">Active parsing processes and their resource usage</p>
                            </div>
                            <button class="btn-destructive px-4 py-2 text-sm flex items-center space-x-2" onclick="killAllAINewsProcesses()">
                                <i class="ri-close-circle-line"></i>
                                <span>Kill All AI News Processes</span>
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead style="background-color: oklch(var(--muted));">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-medium" style="color: oklch(var(--muted-foreground));">PID</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium" style="color: oklch(var(--muted-foreground));">Process Name</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium" style="color: oklch(var(--muted-foreground));">Memory</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium" style="color: oklch(var(--muted-foreground));">CPU</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium" style="color: oklch(var(--muted-foreground));">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="processes-table-body" class="divide-y" style="border-color: oklch(var(--border));">
                                    <tr>
                                        <td colspan="5" class="px-4 py-8 text-center text-sm" style="color: oklch(var(--muted-foreground));">Loading processes...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RSS Tab -->
            <div id="rss-tab" class="tab-content hidden" role="tabpanel" aria-labelledby="rss-tab-button">
                <div class="space-y-6">
                    <!-- RSS Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="card p-6 text-center">
                            <div class="text-3xl font-bold" style="color: oklch(var(--primary));" id="total-rss-feeds">-</div>
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));">Total RSS Feeds</div>
                        </div>
                        <div class="card p-6 text-center">
                            <div class="text-3xl font-bold" style="color: oklch(var(--destructive));" id="error-rss-feeds">-</div>
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));">Error Feeds</div>
                        </div>
                        <div class="card p-6 text-center">
                            <div class="text-3xl font-bold" style="color: oklch(var(--primary));" id="avg-fetch-time">-</div>
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));">Avg Fetch Time (ms)</div>
                        </div>
                    </div>

                    <!-- RSS Feeds List -->
                    <div class="card">
                        <div class="p-6">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b" style="border-color: oklch(var(--border));">
                                            <th class="text-left py-3 px-4 font-medium" style="color: oklch(var(--muted-foreground));">Source</th>
                                            <th class="text-left py-3 px-4 font-medium" style="color: oklch(var(--muted-foreground));">Articles</th>
                                            <th class="text-left py-3 px-4 font-medium" style="color: oklch(var(--muted-foreground));">Errors</th>
                                            <th class="text-left py-3 px-4 font-medium" style="color: oklch(var(--muted-foreground));">Efficiency</th>
                                            <th class="text-left py-3 px-4 font-medium" style="color: oklch(var(--muted-foreground));">Fetch Time</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rss-feeds-table">
                                        <tr>
                                            <td colspan="5" class="text-center py-8" style="color: oklch(var(--muted-foreground));">
                                                Loading RSS feeds...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Errors Tab -->
            <div id="errors-tab" class="tab-content hidden" role="tabpanel" aria-labelledby="errors-tab-button">
                <div class="space-y-6">
                    <!-- Error Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="card p-6 text-center">
                            <div class="text-3xl font-bold" style="color: oklch(var(--destructive));" id="total-errors">-</div>
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));">Total Errors (24h)</div>
                        </div>
                        <div class="card p-6 text-center">
                            <div class="text-3xl font-bold" style="color: oklch(var(--foreground));" id="error-sources-count">-</div>
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));">Sources with Errors</div>
                        </div>
                        <div class="card p-6 text-center">
                            <div class="text-3xl font-bold" style="color: oklch(var(--foreground));" id="last-error-time">-</div>
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));">Last Error</div>
                        </div>
                    </div>

                    <!-- Error List -->
                    <!-- Error Filters -->
                    <div class="card p-4">
                        <div class="flex flex-wrap gap-3">
                            <select id="error-type-filter" class="px-3 py-2 rounded-md" style="background-color: oklch(var(--input)); border: 1px solid oklch(var(--border)); color: oklch(var(--foreground));">
                                <option value="">All Error Types</option>
                                <option value="ERROR">ERROR</option>
                                <option value="CRITICAL">CRITICAL</option>
                                <option value="WARNING">WARNING</option>
                            </select>
                            <select id="error-source-filter" class="px-3 py-2 rounded-md" style="background-color: oklch(var(--input)); border: 1px solid oklch(var(--border)); color: oklch(var(--foreground));">
                                <option value="">All Sources</option>
                            </select>
                            <select id="error-time-filter" class="px-3 py-2 rounded-md" style="background-color: oklch(var(--input)); border: 1px solid oklch(var(--border)); color: oklch(var(--foreground));">
                                <option value="24h">Last 24 hours</option>
                                <option value="7d">Last 7 days</option>
                                <option value="30d">Last 30 days</option>
                            </select>
                            <button onclick="refreshErrorFilters()" class="btn-secondary px-3 py-2 text-sm">
                                <i class="ri-refresh-line"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Error List -->
                    <div class="card p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold" style="color: oklch(var(--foreground));">Recent Errors</h3>
                            <div class="flex space-x-2">
                                <button class="btn-secondary px-4 py-2 text-sm flex items-center space-x-2" onclick="exportErrorsAsText()">
                                    <i class="ri-download-line"></i>
                                    <span>Export as Text</span>
                                </button>
                                <button class="btn-primary px-4 py-2 text-sm flex items-center space-x-2" onclick="copyAllErrorsForDebug()">
                                    <i class="ri-file-copy-line"></i>
                                    <span>Copy All for Debug</span>
                                </button>
                                <button class="btn-secondary px-4 py-2 text-sm flex items-center space-x-2" onclick="clearErrorsList()">
                                    <i class="ri-delete-bin-line"></i>
                                    <span>Clear List</span>
                                </button>
                            </div>
                        </div>
                        <div id="errors-list" class="space-y-3">
                            <div class="text-center py-8 text-sm" style="color: oklch(var(--muted-foreground));">Loading errors...</div>
                        </div>
                        <div id="errors-pagination" class="mt-4 flex justify-between items-center" style="display: none;">
                            <div class="text-sm" style="color: oklch(var(--muted-foreground));" id="errors-info">Showing 0 of 0 errors</div>
                            <div class="flex space-x-2">
                                <button onclick="loadErrorsPage('prev')" class="btn-secondary px-3 py-1 text-sm" id="prev-errors">Previous</button>
                                <button onclick="loadErrorsPage('next')" class="btn-secondary px-3 py-1 text-sm" id="next-errors">Next</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        // Global variables
        let currentTab = 'control';
        let logsPaused = false;
        let refreshInterval;
        let currentErrorsData = null; // Store current errors data

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Show selected tab content
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
                selectedTab.classList.add('fade-in');
            }

            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('tab-active');
                button.classList.add('tab-inactive');
                button.setAttribute('aria-selected', 'false');
            });

            const selectedButton = document.getElementById(tabName + '-tab-button');
            if (selectedButton) {
                selectedButton.classList.remove('tab-inactive');
                selectedButton.classList.add('tab-active');
                selectedButton.setAttribute('aria-selected', 'true');
            }

            currentTab = tabName;
            
            // Load tab-specific data
            loadTabData(tabName);
            
            // Auto-scroll Control tab logs when switching to it
            if (tabName === 'control') {
                // Use setTimeout to ensure DOM is updated first
                setTimeout(autoScrollControlLogs, 100);
            }
        }

        // Global flag to track if articles data was loaded
        let articlesDataLoaded = false;
        
        // Load data for specific tab
        function loadTabData(tabName) {
            switch(tabName) {
                case 'control':
                    loadControlData();
                    break;
                case 'articles':
                    // Всегда загружаем свежие данные
                    loadArticlesData();
                    break;
                case 'memory':
                    loadMemoryData();
                    break;
                case 'rss':
                    loadRSSData();
                    break;
                case 'errors':
                    loadErrorsData();
                    break;
                case 'logs':
                    loadLogsData();
                    break;
            }
        }

        // Placeholder functions for data loading
        function loadControlData() {
            console.log('Loading control data...');
            loadLastParsed();
            loadDatabaseStats();
        }

        // Global pagination state
        let currentPage = 1;
        let totalPages = 1;
        let totalArticles = 0;
        
        // Global filter state
        let activeFilters = {
            source: null,
            date: null,
            status: null
        };
        
        async function loadArticlesData(page = 1) {
            console.log('Loading articles data...');
            const tbody = document.getElementById('articles-table-body');
            
            // Show loading state
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8"><div class="flex items-center justify-center"><div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500 mr-3"></div>Loading articles...</div></td></tr>';
            
            try {
                // Build query parameters with filters
                const params = new URLSearchParams({
                    page: page,
                    limit: 50
                });
                
                // Add active filters
                if (activeFilters.source) params.append('source_filter', activeFilters.source);
                if (activeFilters.date) params.append('date_filter', activeFilters.date);
                if (activeFilters.status) params.append('status', activeFilters.status);
                
                const response = await fetch(`/api/articles?${params}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // Update pagination state
                currentPage = data.page || page;
                totalPages = data.total_pages || 1;
                totalArticles = data.total || 0;
                
                if (data.articles && data.articles.length > 0) {
                    tbody.innerHTML = data.articles.map(article => `
                        <tr class="border-b hover:bg-slate-50">
                            <td class="py-3 px-4 cursor-pointer" onclick="viewArticle('${article.article_id}')">
                                <div class="font-medium text-blue-600 hover:text-blue-800">${escapeHtml(article.title || 'No title')}</div>
                            </td>
                            <td class="py-3 px-4 text-sm cursor-pointer hover:bg-blue-50" onclick="filterBySource('${article.source_id || ''}', '${escapeHtml(article.source_name || 'Unknown')}')" title="Click to filter by this source">
                                ${escapeHtml(article.source_name || 'Unknown')}
                            </td>
                            <td class="py-3 px-4 text-sm cursor-pointer hover:bg-blue-50" onclick="filterByDate('${new Date(article.created_at || article.published_date).toISOString().split('T')[0]}')" title="Click to filter by this date">
                                ${new Date(article.created_at || article.published_date).toLocaleDateString()}
                            </td>
                            <td class="py-3 px-4 text-sm">
                                ${article.url ? `<a href="${article.url}" target="_blank" class="text-blue-500 hover:underline" onclick="event.stopPropagation()"><i class="ri-external-link-line"></i></a>` : '-'}
                            </td>
                            <td class="py-3 px-4 text-sm">
                                ${article.media_count && article.media_count > 0 ? 
                                    `<button class="inline-flex items-center text-blue-600 hover:text-blue-800 hover:bg-blue-50 px-2 py-1 rounded cursor-pointer transition-colors" 
                                            onclick="event.stopPropagation(); viewArticleMedia('${article.article_id}')">
                                        <i class="ri-image-line text-blue-500"></i>
                                        <span class="ml-1 font-medium">${article.media_count}</span>
                                    </button>` : 
                                    '<span class="text-gray-400">-</span>'
                                }
                            </td>
                            <td class="py-3 px-4 cursor-pointer hover:bg-blue-50" onclick="filterByStatus('${article.content_status}')" title="Click to filter by this status">
                                <span class="px-2 py-1 text-xs rounded-full ${
                                    article.content_status === 'parsed' ? 'bg-green-100 text-green-800' : 
                                    article.content_status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                                    'bg-gray-100 text-gray-800'
                                }">${article.content_status === 'parsed' ? 'Parsed' : (article.content_status === 'pending' ? 'Pending' : (article.content_status === 'failed' ? 'Failed' : (article.content_status === 'published' ? 'Published' : (article.content_status || 'Unknown'))))}</span>
                            </td>
                            <td class="py-3 px-4 text-center">
                                <button class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded transition-colors" 
                                        onclick="event.stopPropagation(); deleteArticle('${article.article_id}', '${escapeHtml(article.title || 'No title')}')"
                                        title="Delete article">
                                    <i class="ri-close-line text-lg"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No articles found</td></tr>';
                }
                
                // Update pagination controls
                updatePaginationControls();
                
            } catch (error) {
                console.error('Error loading articles:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-red-500">Error loading articles. Please try again.</td></tr>';
            }
        }
        
        function updatePaginationControls() {
            // Update pagination info
            const startItem = (currentPage - 1) * 50 + 1;
            const endItem = Math.min(currentPage * 50, totalArticles);
            
            document.getElementById('articles-pagination-info').textContent = 
                `Showing ${startItem}-${endItem} of ${totalArticles} articles`;
            
            document.getElementById('articles-page-info').textContent = 
                `Page ${currentPage} of ${totalPages}`;
            
            // Enable/disable buttons
            const prevBtn = document.getElementById('articles-prev-btn');
            const nextBtn = document.getElementById('articles-next-btn');
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            // Update button classes for visual feedback
            if (prevBtn.disabled) {
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (nextBtn.disabled) {
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
        
        function loadArticlesPage(direction) {
            let newPage = currentPage;
            
            if (direction === 'prev' && currentPage > 1) {
                newPage = currentPage - 1;
            } else if (direction === 'next' && currentPage < totalPages) {
                newPage = currentPage + 1;
            }
            
            if (newPage !== currentPage) {
                loadArticlesData(newPage);
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Make viewArticle globally available
        async function viewArticle(articleId) {
            try {
                console.log('Loading article:', articleId);
                const response = await fetch(`/api/articles/${articleId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const article = await response.json();
                showArticleModal(article);
            } catch (error) {
                console.error('Error loading article:', error);
                alert('Ошибка загрузки статьи: ' + error.message);
            }
        }
        
        async function deleteArticle(articleId, articleTitle) {
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to delete this article?\n\n"${articleTitle}"\n\nThis action cannot be undone and will also delete any associated media files.`)) {
                return;
            }
            
            try {
                console.log('Deleting article:', articleId);
                const response = await fetch(`/api/articles/${articleId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Article deleted successfully:', result);
                
                // Show success message
                showNotification(`Article deleted successfully: "${articleTitle}"`, 'success');
                
                // Reload the articles table to reflect changes
                await loadArticlesData(currentPage);
                
            } catch (error) {
                console.error('Error deleting article:', error);
                showNotification(`Error deleting article: ${error.message}`, 'error');
            }
        }
        
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg max-w-md ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="flex-1">${escapeHtml(message)}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        function showArticleModal(article) {
            // Create modal HTML
            const modalHTML = `
                <div id="article-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) closeArticleModal()">
                    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="p-6 border-b">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 mr-4">
                                    <h2 class="text-xl font-bold mb-2">${escapeHtml(article.title || 'No title')}</h2>
                                    <div class="text-sm text-gray-500">
                                        <span>${escapeHtml(article.source_name || 'Unknown source')}</span> • 
                                        <span>${new Date(article.created_at || article.published_date).toLocaleDateString()}</span>
                                        ${article.url ? ` • <a href="${article.url}" target="_blank" class="text-blue-500 hover:underline">Оригинал</a>` : ''}
                                    </div>
                                </div>
                                <button onclick="closeArticleModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                                    ×
                                </button>
                            </div>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[60vh]">
                            ${article.description ? `<div class="mb-4 text-gray-700 italic">${escapeHtml(article.description)}</div>` : ''}
                            <div class="prose max-w-none">
                                ${article.content || '<p class="text-gray-500">Содержимое недоступно</p>'}
                            </div>
                            ${article.media_files && article.media_files.length > 0 ? `
                                <div class="mt-6 border-t pt-4">
                                    <h3 class="text-lg font-semibold mb-3">Media Files (${article.media_files.length})</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        ${article.media_files.map(media => `
                                            <div class="border rounded p-3">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="text-sm font-medium">
                                                        <i class="ri-${media.type === 'image' ? 'image' : 'video'}-line mr-1"></i>
                                                        ${media.type || 'unknown'}
                                                    </span>
                                                    <span class="px-2 py-1 text-xs rounded ${
                                                        media.status === 'completed' ? 'bg-green-100 text-green-800' : 
                                                        media.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                                                        'bg-gray-100 text-gray-800'
                                                    }">${media.status || 'unknown'}</span>
                                                </div>
                                                ${media.url ? `<a href="${media.url}" target="_blank" class="text-xs text-blue-500 hover:underline truncate block">${media.url}</a>` : ''}
                                                ${media.file_path ? `<div class="text-xs text-gray-500 mt-1">Local: ${media.file_path}</div>` : ''}
                                                ${media.width && media.height ? `<div class="text-xs text-gray-500">${media.width}x${media.height}</div>` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function closeArticleModal() {
            const modal = document.getElementById('article-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Filter functions
        function filterBySource(sourceId, sourceName) {
            activeFilters.source = sourceId;
            activeFilters.date = null;
            activeFilters.status = null;
            currentPage = 1;
            loadArticlesData(1);
            showActiveFilter('source', sourceName || sourceId);
        }
        
        function filterByDate(date) {
            // Convert date to a filter that API understands
            const today = new Date();
            const filterDate = new Date(date);
            const diffTime = Math.abs(today - filterDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let dateFilter;
            if (diffDays <= 1) {
                dateFilter = '24h';
            } else if (diffDays <= 7) {
                dateFilter = '7d';
            } else if (diffDays <= 30) {
                dateFilter = '30d';
            } else {
                dateFilter = 'all';
            }
            
            activeFilters.date = dateFilter;
            activeFilters.source = null;
            activeFilters.status = null;
            currentPage = 1;
            loadArticlesData(1);
            showActiveFilter('date', filterDate.toLocaleDateString());
        }
        
        function filterByStatus(status) {
            activeFilters.status = status;
            activeFilters.source = null;
            activeFilters.date = null;
            currentPage = 1;
            loadArticlesData(1);
            showActiveFilter('status', status);
        }
        
        function clearFilters() {
            activeFilters = {
                source: null,
                date: null,
                status: null
            };
            currentPage = 1;
            loadArticlesData(1);
            hideActiveFilter();
        }

        // Filter dropdown functions
        function toggleSourceFilter() {
            const dropdown = document.getElementById('source-filter-dropdown');
            const isVisible = !dropdown.classList.contains('hidden');
            
            // Hide all dropdowns first
            hideAllFilterDropdowns();
            
            if (!isVisible) {
                dropdown.classList.remove('hidden');
                loadSourceFilterOptions();
            }
        }

        function toggleDateFilter() {
            const dropdown = document.getElementById('date-filter-dropdown');
            const isVisible = !dropdown.classList.contains('hidden');
            
            // Hide all dropdowns first
            hideAllFilterDropdowns();
            
            if (!isVisible) {
                dropdown.classList.remove('hidden');
                loadDateFilterOptions();
            }
        }

        function toggleStatusFilter() {
            const dropdown = document.getElementById('status-filter-dropdown');
            const isVisible = !dropdown.classList.contains('hidden');
            
            // Hide all dropdowns first
            hideAllFilterDropdowns();
            
            if (!isVisible) {
                dropdown.classList.remove('hidden');
                loadStatusFilterOptions();
            }
        }

        function hideAllFilterDropdowns() {
            document.getElementById('source-filter-dropdown').classList.add('hidden');
            document.getElementById('date-filter-dropdown').classList.add('hidden');
            document.getElementById('status-filter-dropdown').classList.add('hidden');
        }

        // Load filter options
        async function loadSourceFilterOptions() {
            const container = document.getElementById('source-filter-options');
            try {
                const response = await fetch('/api/articles/sources');
                const data = await response.json();
                
                let html = '';
                // Add "All sources" option
                html += `<div class="p-2 cursor-pointer hover:bg-gray-100 text-sm" onclick="selectSourceFilter(null, 'All sources')">
                    <div class="font-medium">All sources</div>
                </div>`;
                
                // Add individual sources
                data.sources.forEach(source => {
                    const escapedName = source.name.replace(/'/g, "\\'");
                    html += `<div class="p-2 cursor-pointer hover:bg-gray-100 text-sm" onclick="selectSourceFilter('${source.source_id}', '${escapedName}')">
                        <div class="font-medium">${escapeHtml(source.name)}</div>
                        <div class="text-gray-500 text-xs">${source.article_count} articles</div>
                    </div>`;
                });
                
                container.innerHTML = html;
                // Initialize search after content is loaded
                setTimeout(initializeSourceSearch, 100);
            } catch (error) {
                container.innerHTML = '<div class="p-2 text-sm text-red-500">Error loading sources</div>';
            }
        }

        async function loadDateFilterOptions() {
            const container = document.getElementById('date-filter-options');
            try {
                const response = await fetch('/api/articles/dates');
                const data = await response.json();
                
                let html = '';
                // Add "All dates" option
                html += `<div class="p-2 cursor-pointer hover:bg-gray-100 text-sm" onclick="selectDateFilter(null, 'All dates')">
                    <div class="font-medium">All dates</div>
                </div>`;
                
                // Add predefined ranges
                data.predefined_ranges.forEach(range => {
                    html += `<div class="p-2 cursor-pointer hover:bg-gray-100 text-sm" onclick="selectDateFilter('${range.value}', '${range.label}')">
                        <div class="font-medium">${range.label}</div>
                    </div>`;
                });
                
                // Add recent specific dates
                if (data.recent_dates && data.recent_dates.length > 0) {
                    html += '<div class="border-t mt-2 pt-2"><div class="px-2 text-xs text-gray-500 font-medium">Recent dates:</div></div>';
                    data.recent_dates.slice(0, 10).forEach(date => {
                        html += `<div class="p-2 cursor-pointer hover:bg-gray-100 text-sm" onclick="selectDateFilter('${date.value}', '${date.label}')">
                            <div class="font-medium">${date.label}</div>
                            <div class="text-gray-500 text-xs">${date.count} articles</div>
                        </div>`;
                    });
                }
                
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<div class="p-2 text-sm text-red-500">Error loading dates</div>';
            }
        }

        async function loadStatusFilterOptions() {
            const container = document.getElementById('status-filter-options');
            try {
                const response = await fetch('/api/articles/statuses');
                const data = await response.json();
                
                let html = '';
                // Add "All statuses" option
                html += `<div class="p-2 cursor-pointer hover:bg-gray-100 text-sm" onclick="selectStatusFilter(null, 'All statuses')">
                    <div class="font-medium">All statuses</div>
                </div>`;
                
                // Add individual statuses
                data.statuses.forEach(status => {
                    html += `<div class="p-2 cursor-pointer hover:bg-gray-100 text-sm" onclick="selectStatusFilter('${status.status}', '${status.status}')">
                        <div class="font-medium">${escapeHtml(status.status)}</div>
                        <div class="text-gray-500 text-xs">${status.count} articles</div>
                    </div>`;
                });
                
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<div class="p-2 text-sm text-red-500">Error loading statuses</div>';
            }
        }

        // Filter selection functions
        function selectSourceFilter(sourceId, sourceName) {
            if (sourceId) {
                filterBySource(sourceId, sourceName);
            } else {
                activeFilters.source = null;
                currentPage = 1;
                loadArticlesData(1);
                hideActiveFilter();
            }
            hideAllFilterDropdowns();
        }

        function selectDateFilter(dateValue, dateLabel) {
            if (dateValue) {
                if (dateValue.includes('-')) {
                    // Specific date
                    filterByDate(dateValue);
                } else {
                    // Predefined range
                    activeFilters.date = dateValue;
                    activeFilters.source = null;
                    activeFilters.status = null;
                    currentPage = 1;
                    loadArticlesData(1);
                    showActiveFilter('date', dateLabel);
                }
            } else {
                activeFilters.date = null;
                currentPage = 1;
                loadArticlesData(1);
                hideActiveFilter();
            }
            hideAllFilterDropdowns();
        }

        function selectStatusFilter(statusValue, statusLabel) {
            if (statusValue) {
                filterByStatus(statusValue);
            } else {
                activeFilters.status = null;
                currentPage = 1;
                loadArticlesData(1);
                hideActiveFilter();
            }
            hideAllFilterDropdowns();
        }

        // Search functionality for source filter
        function initializeSourceSearch() {
            const searchInput = document.getElementById('source-search');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    const options = document.querySelectorAll('#source-filter-options > div');
                    
                    options.forEach(option => {
                        const text = option.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            option.style.display = 'block';
                        } else {
                            option.style.display = 'none';
                        }
                    });
                });
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const sourceDropdown = document.getElementById('source-filter-dropdown');
            const dateDropdown = document.getElementById('date-filter-dropdown');
            const statusDropdown = document.getElementById('status-filter-dropdown');
            
            const sourceBtn = document.getElementById('source-filter-btn');
            const dateBtn = document.getElementById('date-filter-btn');
            const statusBtn = document.getElementById('status-filter-btn');
            
            // Check if click is outside all filter elements
            if (!sourceDropdown.contains(event.target) && !sourceBtn.contains(event.target) &&
                !dateDropdown.contains(event.target) && !dateBtn.contains(event.target) &&
                !statusDropdown.contains(event.target) && !statusBtn.contains(event.target)) {
                hideAllFilterDropdowns();
            }
        });
        
        function showActiveFilter(type, value) {
            // Create or update filter indicator
            let filterDiv = document.getElementById('active-filter-indicator');
            if (!filterDiv) {
                filterDiv = document.createElement('div');
                filterDiv.id = 'active-filter-indicator';
                filterDiv.className = 'mb-4 p-3 bg-blue-50 rounded-lg flex items-center justify-between';
                const articlesTab = document.getElementById('articles-tab');
                const spaceDiv = articlesTab.querySelector('.space-y-6');
                if (spaceDiv) {
                    spaceDiv.insertBefore(filterDiv, spaceDiv.firstChild);
                }
            }
            
            filterDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="ri-filter-line text-blue-500 mr-2"></i>
                    <span class="text-sm">Filtering by ${type}: <strong>${value}</strong></span>
                </div>
                <button onclick="clearFilters()" class="btn-secondary px-3 py-1 text-sm">
                    <i class="ri-close-line mr-1"></i> Clear Filter
                </button>
            `;
        }
        
        function hideActiveFilter() {
            const filterDiv = document.getElementById('active-filter-indicator');
            if (filterDiv) {
                filterDiv.remove();
            }
        }

        let isLoadingMemoryData = false;
        async function loadMemoryData() {
            // Prevent multiple simultaneous calls
            if (isLoadingMemoryData) return;
            isLoadingMemoryData = true;
            
            console.log('Loading memory data...');
            try {
                const response = await fetch('/api/memory/current');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // Update CPU usage
                const cpuElement = document.getElementById('cpu-usage');
                if (cpuElement) {
                    cpuElement.textContent = `${data.cpu_percent || 0}%`;
                    // Update progress bar
                    const cpuProgress = document.getElementById('cpu-progress');
                    if (cpuProgress) cpuProgress.style.width = `${data.cpu_percent || 0}%`;
                }
                
                // Load process list to calculate AI News memory usage
                const processesResponse = await fetch('/api/memory/processes');
                let aiNewsMemoryMB = 0;
                let aiNewsProcessCount = 0;
                
                let processesData = null;
                if (processesResponse.ok) {
                    processesData = await processesResponse.json();
                    const aiNewsProcesses = processesData.processes || [];
                    
                    // Calculate total memory used by AI News processes
                    aiNewsMemoryMB = aiNewsProcesses.reduce((sum, proc) => sum + (proc.memory_mb || 0), 0);
                    aiNewsProcessCount = aiNewsProcesses.length;
                }
                
                // Update Memory usage (AI News system memory in MB, not PC %)
                const memoryElement = document.getElementById('memory-usage');
                if (memoryElement) {
                    memoryElement.textContent = `${aiNewsMemoryMB.toFixed(1)} MB`;
                }
                
                // Update Total processes (AI News only)
                const processesElement = document.getElementById('total-processes');
                if (processesElement) {
                    processesElement.textContent = aiNewsProcessCount || '0';
                }
                
                // Update Disk usage
                const diskElement = document.getElementById('disk-usage');
                if (diskElement) {
                    diskElement.textContent = `${data.disk_percent || 0}%`;
                    // Update progress bar
                    const diskProgress = document.getElementById('disk-progress');
                    if (diskProgress) diskProgress.style.width = `${data.disk_percent || 0}%`;
                }
                
                // Update Process Manager table using the already parsed data
                if (processesData) {
                    const processes = processesData;
                    const tbody = document.getElementById('processes-table-body');
                    if (tbody && processes.processes) {
                        if (processes.processes.length === 0) {
                            tbody.innerHTML = `
                                <tr>
                                    <td colspan="5" class="px-4 py-8 text-center text-sm" style="color: oklch(var(--muted-foreground));">
                                        No AI News processes running
                                    </td>
                                </tr>
                            `;
                        } else {
                            tbody.innerHTML = processes.processes.map(proc => {
                                // Define colors and icons for different process types
                                const typeColors = {
                                    'database': 'bg-green-100 text-green-800',
                                    'monitoring': 'bg-purple-100 text-purple-800', 
                                    'parser': 'bg-blue-100 text-blue-800',
                                    'crawler': 'bg-orange-100 text-orange-800',
                                    'python': 'bg-yellow-100 text-yellow-800',
                                    'node': 'bg-emerald-100 text-emerald-800',
                                    'shell': 'bg-gray-100 text-gray-800',
                                    'unknown': 'bg-red-100 text-red-800'
                                };
                                
                                const typeIcons = {
                                    'database': '🗄️',
                                    'monitoring': '📊',
                                    'parser': '📰',
                                    'crawler': '🕷️',
                                    'python': '🐍',
                                    'node': '🟢',
                                    'shell': '🛠️',
                                    'unknown': '❓'
                                };
                                
                                const colorClass = typeColors[proc.process_type] || typeColors['unknown'];
                                const icon = typeIcons[proc.process_type] || typeIcons['unknown'];
                                
                                return `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 text-sm font-mono">${proc.pid}</td>
                                        <td class="px-4 py-3 text-sm">
                                            <div class="font-medium" title="${proc.technical_details || proc.cmdline || proc.name}">
                                                ${icon} ${proc.human_name || proc.name}
                                            </div>
                                            <div class="text-xs mt-1" style="color: oklch(var(--muted-foreground));">
                                                <span class="inline-block ${colorClass} px-2 py-0.5 rounded text-xs font-medium">
                                                    ${proc.process_type.charAt(0).toUpperCase() + proc.process_type.slice(1)}
                                                </span>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 text-sm font-mono">
                                            <span class="font-semibold">${proc.memory_mb.toFixed(1)}</span> MB
                                        </td>
                                        <td class="px-4 py-3 text-sm">
                                            <div class="flex items-center space-x-2">
                                                <span class="font-mono">${proc.cpu_percent.toFixed(1)}%</span>
                                                <div class="w-8 bg-gray-200 rounded-full h-2">
                                                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${Math.min(proc.cpu_percent, 100)}%"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-4 py-3 text-sm">
                                            <button onclick="killProcess(${proc.pid})" class="btn-destructive px-3 py-1 text-xs flex items-center space-x-1 hover:bg-red-600">
                                                <i class="ri-close-circle-line"></i>
                                                <span>Kill</span>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            }).join('');
                        }
                    }
                } else {
                    // If no process data, show error message
                    const tbody = document.getElementById('processes-table-body');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" class="px-4 py-8 text-center text-sm text-red-600">
                                    Failed to load AI News processes
                                </td>
                            </tr>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading memory data:', error);
            } finally {
                // Reset loading flag
                isLoadingMemoryData = false;
            }
        }

        async function loadErrorsData() {
            console.log('Loading errors data...');
            try {
                const response = await fetch('/api/errors/recent?limit=50');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                currentErrorsData = data; // Save data globally
                
                // Update stats
                const stats = document.querySelectorAll('#errors-tab .text-3xl');
                if (stats[0]) stats[0].textContent = data.total_errors || '0';
                if (stats[1]) stats[1].textContent = data.sources_with_errors || '0';
                if (stats[2]) stats[2].textContent = data.last_error_time ? new Date(data.last_error_time).toLocaleTimeString() : '-';
                
                // Update errors list
                const errorContainer = document.getElementById('errors-list');
                if (errorContainer) {
                    if (data.errors && data.errors.length > 0) {
                        errorContainer.innerHTML = data.errors.map(error => `
                            <div class="border rounded p-4 mb-4 ${error.level === 'CRITICAL' ? 'border-red-500' : 'border-gray-300'}">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <span class="px-2 py-1 text-xs rounded ${getErrorLevelClass(error.level)}">
                                            ${error.level}
                                        </span>
                                        <span class="ml-2 text-sm text-gray-600">${error.source_id || 'Unknown'}</span>
                                    </div>
                                    <span class="text-xs text-gray-500">${new Date(error.timestamp).toLocaleString()}</span>
                                </div>
                                <div class="font-mono text-sm">${error.error_message}</div>
                                ${error.error_type ? `<div class="text-xs text-gray-500 mt-1">Type: ${error.error_type}</div>` : ''}
                                ${error.context ? `<details class="mt-2"><summary class="cursor-pointer text-xs text-blue-600">Context</summary><pre class="text-xs mt-1 p-2 bg-gray-100 rounded overflow-x-auto">${JSON.stringify(error.context, null, 2)}</pre></details>` : ''}
                            </div>
                        `).join('');
                    } else {
                        errorContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No errors in the last 24 hours</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading errors data:', error);
            }
        }

        async function loadLogsData() {
            console.log('Loading logs data...');
            try {
                const response = await fetch('/api/logs/recent?limit=100');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // Update logs container
                const logsContainer = document.querySelector('#logs-tab .font-mono');
                if (logsContainer && data.logs) {
                    logsContainer.innerHTML = data.logs.map(log => `
                        <div class="flex items-start space-x-2 mb-1 hover:bg-gray-50 px-2 py-1 rounded">
                            <span class="text-xs text-gray-500 whitespace-nowrap">${new Date(log.timestamp).toLocaleTimeString()}</span>
                            <span class="px-1 py-0.5 text-xs rounded ${getLogLevelClass(log.level)}">${log.level}</span>
                            <span class="text-sm flex-1">${log.message}</span>
                        </div>
                    `).join('');
                } else if (logsContainer) {
                    logsContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No logs available</div>';
                }
            } catch (error) {
                console.error('Error loading logs data:', error);
            }
        }

        // Extract system state
        let extractState = {
            rss: false,
            parse: false,
            media: false
        };

        // Function to update button states based on actual process status
        async function updateExtractButtonStates() {
            try {
                const response = await fetch('/api/extract/status');
                if (response.ok) {
                    const status = await response.json();
                    
                    // Update RSS button
                    const rssButton = document.getElementById('rss-toggle');
                    const rssIcon = document.getElementById('rss-icon');
                    const rssText = document.getElementById('rss-text');
                    
                    if (status.rss && status.rss.running) {
                        extractState.rss = true;
                        rssButton.className = "extract-btn extract-btn-destructive";
                        rssIcon.classList.add('animate-pulse');
                        rssText.textContent = 'Stop RSS';
                    } else {
                        extractState.rss = false;
                        rssButton.className = "extract-btn extract-btn-primary";
                        rssIcon.classList.remove('animate-pulse');
                        rssText.textContent = 'Start RSS';
                    }
                    
                    // Update Parse button
                    const parseButton = document.getElementById('parse-toggle');
                    const parseIcon = document.getElementById('parse-icon');
                    const parseText = document.getElementById('parse-text');
                    
                    if (status.parse && status.parse.running) {
                        extractState.parse = true;
                        parseButton.className = "extract-btn extract-btn-destructive";
                        parseIcon.classList.add('animate-pulse');
                        parseText.textContent = 'Stop Parse';
                    } else {
                        extractState.parse = false;
                        parseButton.className = "extract-btn extract-btn-primary";
                        parseIcon.classList.remove('animate-pulse');
                        parseText.textContent = 'Start Parse';
                    }
                    
                    // Update Media button
                    const mediaButton = document.getElementById('media-toggle');
                    const mediaIcon = document.getElementById('media-icon');
                    const mediaText = document.getElementById('media-text');
                    
                    if (status.media && status.media.running) {
                        extractState.media = true;
                        mediaButton.className = "extract-btn extract-btn-destructive";
                        mediaIcon.classList.add('animate-pulse');
                        mediaText.textContent = 'Stop Media';
                    } else {
                        extractState.media = false;
                        mediaButton.className = "extract-btn extract-btn-primary";
                        mediaIcon.classList.remove('animate-pulse');
                        mediaText.textContent = 'Start Media';
                    }
                    
                    // Enable all buttons after status update
                    rssButton.disabled = false;
                    parseButton.disabled = false;
                    mediaButton.disabled = false;
                }
            } catch (error) {
                console.error('Failed to fetch Extract system status:', error);
            }
        }

        // Control functions for Extract system
        async function toggleRSS() {
            const button = document.getElementById('rss-toggle');
            const icon = document.getElementById('rss-icon');
            const text = document.getElementById('rss-text');
            
            if (!extractState.rss) {
                // Immediate UI feedback
                button.disabled = true;
                button.className = "extract-btn extract-btn-loading";
                text.textContent = 'Starting...';
                
                try {
                    const response = await fetch('/api/extract/rss/start', { method: 'POST' });
                    if (response.ok) {
                        extractState.rss = true;
                        button.className = "extract-btn extract-btn-destructive";
                        
                        // Start log streaming when starting RSS
                        startLogStreaming();
                        icon.classList.add('animate-pulse');
                        text.textContent = 'Stop RSS';
                        button.disabled = false;
                        showNotification('RSS Discovery started', 'success');
                    }
                } catch (error) {
                    button.disabled = false;
                    button.className = "extract-btn extract-btn-primary";
                    text.textContent = 'Start RSS';
                    showNotification('Failed to start RSS Discovery', 'error');
                }
            } else {
                // Immediate UI feedback
                button.disabled = true;
                button.className = "extract-btn extract-btn-loading";
                text.textContent = 'Stopping...';
                
                try {
                    const response = await fetch('/api/extract/rss/stop', { method: 'POST' });
                    if (response.ok) {
                        extractState.rss = false;
                        button.className = "extract-btn extract-btn-primary";
                        icon.classList.remove('animate-pulse');
                        text.textContent = 'Start RSS';
                        button.disabled = false;
                        showNotification('RSS Discovery stopped', 'warning');
                    }
                } catch (error) {
                    button.disabled = false;
                    button.className = "extract-btn extract-btn-destructive";
                    text.textContent = 'Stop RSS';
                    showNotification('Failed to stop RSS Discovery', 'error');
                }
            }
        }

        async function toggleParse() {
            const button = document.getElementById('parse-toggle');
            const icon = document.getElementById('parse-icon');
            const text = document.getElementById('parse-text');
            
            if (!extractState.parse) {
                // Immediate UI feedback
                button.disabled = true;
                button.className = "extract-btn extract-btn-loading";
                text.textContent = 'Starting...';
                
                try {
                    const response = await fetch('/api/extract/parse/start', { method: 'POST' });
                    if (response.ok) {
                        extractState.parse = true;
                        button.className = "extract-btn extract-btn-destructive";
                        
                        // Start log streaming when starting Parse
                        startLogStreaming();
                        icon.classList.add('animate-pulse');
                        text.textContent = 'Stop Parse';
                        button.disabled = false;
                        showNotification('Extract API parsing started', 'success');
                    }
                } catch (error) {
                    button.disabled = false;
                    button.className = "extract-btn extract-btn-primary";
                    text.textContent = 'Start Parse';
                    showNotification('Failed to start parsing', 'error');
                }
            } else {
                // Immediate UI feedback
                button.disabled = true;
                button.className = "extract-btn extract-btn-loading";
                text.textContent = 'Stopping...';
                
                try {
                    const response = await fetch('/api/extract/parse/stop', { method: 'POST' });
                    if (response.ok) {
                        extractState.parse = false;
                        button.className = "extract-btn extract-btn-primary";
                        icon.classList.remove('animate-pulse');
                        text.textContent = 'Start Parse';
                        button.disabled = false;
                        showNotification('Extract API parsing stopped', 'warning');
                    }
                } catch (error) {
                    button.disabled = false;
                    button.className = "extract-btn extract-btn-destructive";
                    text.textContent = 'Stop Parse';
                    showNotification('Failed to stop parsing', 'error');
                }
            }
        }

        async function toggleMedia() {
            const button = document.getElementById('media-toggle');
            const icon = document.getElementById('media-icon');
            const text = document.getElementById('media-text');
            
            if (!extractState.media) {
                // Immediate UI feedback
                button.disabled = true;
                button.className = "extract-btn extract-btn-loading";
                text.textContent = 'Starting...';
                
                try {
                    const response = await fetch('/api/extract/media/start', { method: 'POST' });
                    if (response.ok) {
                        extractState.media = true;
                        button.className = "extract-btn extract-btn-destructive";
                        
                        // Start log streaming when starting Media
                        startLogStreaming();
                        icon.classList.add('animate-pulse');
                        text.textContent = 'Stop Media';
                        button.disabled = false;
                        showNotification('Media download started', 'success');
                    }
                } catch (error) {
                    button.disabled = false;
                    button.className = "extract-btn extract-btn-primary";
                    text.textContent = 'Start Media';
                    showNotification('Failed to start media download', 'error');
                }
            } else {
                // Immediate UI feedback
                button.disabled = true;
                button.className = "extract-btn extract-btn-loading";
                text.textContent = 'Stopping...';
                
                try {
                    const response = await fetch('/api/extract/media/stop', { method: 'POST' });
                    if (response.ok) {
                        extractState.media = false;
                        button.className = "extract-btn extract-btn-primary";
                        icon.classList.remove('animate-pulse');
                        text.textContent = 'Start Media';
                        button.disabled = false;
                        showNotification('Media download stopped', 'warning');
                    }
                } catch (error) {
                    button.disabled = false;
                    button.className = "extract-btn extract-btn-destructive";
                    text.textContent = 'Stop Media';
                    showNotification('Failed to stop media download', 'error');
                }
            }
        }

        function killAllAINewsProcesses() {
            if (confirm('Are you sure you want to kill all AI News processes? This will stop all parsing activity.')) {
                showNotification('Killing all AI News processes...', 'warning');
            }
        }

        function copyErrorsForDebug() {
            // Implementation for copying errors to clipboard
            showNotification('Errors copied to clipboard for debugging', 'success');
        }
        
        // Log streaming functions
        let logSocket = null;
        let logBuffer = [];
        const MAX_LOG_ENTRIES = 300; // Keep last 300 log entries
        const LOG_STORAGE_KEY = 'ai_news_control_logs';
        let logFilter = null;
        
        // Functions for log persistence
        function saveLogsToStorage() {
            try {
                const logsData = logBuffer.map(entry => {
                    const level = Array.from(entry.classList).find(c => c.startsWith('log-'))?.replace('log-', '') || 'info';
                    const textContent = entry.textContent || '';
                    return {
                        level: level,
                        message: textContent,
                        timestamp: new Date().toISOString()
                    };
                });
                localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logsData));
            } catch (error) {
                console.warn('Failed to save logs to localStorage:', error);
            }
        }
        
        function loadLogsFromStorage() {
            try {
                const saved = localStorage.getItem(LOG_STORAGE_KEY);
                if (saved) {
                    const logsData = JSON.parse(saved);
                    const container = document.getElementById('log-container');
                    
                    // Clear placeholder
                    const placeholder = container.querySelector('.text-gray-400.text-center');
                    if (placeholder) {
                        placeholder.remove();
                    }
                    
                    // Clear existing buffer to prevent duplicates
                    logBuffer = [];
                    container.innerHTML = '';
                    
                    // Restore logs (oldest first to match normal flow)
                    logsData.forEach(logData => {
                        const entry = document.createElement('div');
                        entry.className = `log-entry log-${logData.level.toLowerCase()} mb-1`;
                        
                        // Format timestamp if available
                        const time = logData.timestamp ? new Date(logData.timestamp).toLocaleTimeString() : '';
                        const timeSpan = time ? `<span class="text-gray-400 text-xs">[${time}] </span>` : '';
                        
                        entry.innerHTML = `${timeSpan}<span class="text-gray-200">${escapeHtml(logData.message)}</span>`;
                        
                        // Add to buffer and container in correct order
                        logBuffer.push(entry);
                        container.appendChild(entry);
                    });
                    
                    // Limit buffer size (remove oldest entries if over limit)
                    if (logBuffer.length > MAX_LOG_ENTRIES) {
                        const excess = logBuffer.splice(0, logBuffer.length - MAX_LOG_ENTRIES);
                        excess.forEach(entry => entry.remove());
                    }
                    
                    // Auto-scroll to top after loading from storage
                    autoScrollControlLogs();
                }
            } catch (error) {
                console.warn('Failed to load logs from localStorage:', error);
            }
        }
        
        // Auto-scroll function specifically for Control tab logs
        function autoScrollControlLogs() {
            // Only auto-scroll if we're on the Control tab
            if (currentTab === 'control') {
                const logContainer = document.getElementById('log-container');
                if (logContainer) {
                    // Scroll to top instead of bottom
                    logContainer.scrollTop = 0;
                }
            }
        }
        
        function startLogStreaming() {
            if (logSocket && logSocket.readyState === WebSocket.OPEN) {
                return; // Already connected
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/extract/ws/logs`;
            
            logSocket = new WebSocket(wsUrl);
            
            logSocket.onopen = () => {
                console.log('Log streaming connected');
                clearLogs();
                addLogEntry('info', 'Log streaming started...');
            };
            
            logSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    // Handle Extract API log format
                    if (data.phase && data.message) {
                        // Direct log from Extract API - message already contains full info
                        const level = data.level || 'info';
                        const message = data.message;
                        const timestamp = data.timestamp;
                        addLogEntry(level, message, timestamp);
                    } else if (data.type === 'connection_established') {
                        // Connection confirmation
                        console.log(data.message);
                        addLogEntry('info', 'Extract API log streaming connected');
                    } else if (data.type === 'log_entry' && data.log) {
                        // Fallback: main app log format
                        const log = data.log;
                        if (log.logger && log.logger.includes('extract_system')) {
                            const parts = log.logger.split('.');
                            const phase = parts[1] || 'general';
                            const message = `[${phase}] ${log.message}`;
                            addLogEntry(log.level || 'info', message, log.timestamp);
                        }
                    }
                } catch (error) {
                    // Plain text message - log as info
                    if (typeof event.data === 'string' && event.data.trim()) {
                        addLogEntry('info', event.data.trim());
                    }
                    console.error('Failed to parse log message:', error);
                }
            };
            
            logSocket.onclose = (event) => {
                console.log('Log streaming disconnected', event);
                addLogEntry('warning', `Log streaming stopped (Code: ${event.code})`);
                
                // Auto-reconnect after 3 seconds if connection was closed unexpectedly
                if (event.code !== 1000) { // 1000 = normal closure
                    setTimeout(() => {
                        if (!logSocket || logSocket.readyState === WebSocket.CLOSED) {
                            addLogEntry('info', 'Attempting to reconnect log streaming...');
                            startLogStreaming();
                        }
                    }, 3000);
                }
            };
            
            logSocket.onerror = (error) => {
                console.error('Log streaming error:', error);
                addLogEntry('error', 'Log streaming connection error - check if Extract API is running');
            };
        }
        
        function addLogEntry(level, message, timestamp) {
            // Initialize log filter if not exists
            if (!logFilter) {
                logFilter = new LogFilter();
            }
            
            // Process log through filter
            const filtered = logFilter.processLog(level, message, timestamp);
            if (!filtered) {
                return; // Skip this log
            }
            
            const container = document.getElementById('log-container');
            const filter = document.getElementById('log-level-filter').value;
            
            // Apply level filter
            if (filter !== 'all' && level.toLowerCase() !== filter) {
                return;
            }
            
            // Handle array of messages (from buffer)
            const messages = Array.isArray(filtered) ? filtered : [filtered];
            
            messages.forEach(msg => {
                // Create log entry
                const entry = document.createElement('div');
                entry.className = `log-entry log-${level.toLowerCase()} mb-1`;
                
                const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
                
                // Simplified display - msg already contains formatted time from logFilter
                entry.innerHTML = `
                    <span class="text-gray-200">${escapeHtml(msg)}</span>
                `;
                
                // Remove placeholder if exists
                const placeholder = container.querySelector('.text-gray-400.text-center');
                if (placeholder) {
                    placeholder.remove();
                }
                
                // Add to buffer (at beginning)
                logBuffer.unshift(entry);
                if (logBuffer.length > MAX_LOG_ENTRIES) {
                    const removed = logBuffer.pop();
                    removed.remove();
                }
                
                // Add new entry at the top
                if (container.firstChild) {
                    container.insertBefore(entry, container.firstChild);
                } else {
                    container.appendChild(entry);
                }
            });
            
            // Save logs to localStorage after adding new entries
            saveLogsToStorage();
            
            // Auto-scroll for Control tab only - DISABLED to keep logs at top
            // autoScrollControlLogs();
        }
        
        function clearLogs() {
            const container = document.getElementById('log-container');
            container.innerHTML = `
                <div class="text-gray-400 text-center py-8">
                    <i class="ri-terminal-line text-2xl mb-2"></i>
                    <p>Logs will appear here when Extract system is running...</p>
                </div>
            `;
            logBuffer = [];
            // Clear saved logs from localStorage
            try {
                localStorage.removeItem(LOG_STORAGE_KEY);
            } catch (error) {
                console.warn('Failed to clear logs from localStorage:', error);
            }
        }
        
        function filterLogs() {
            const filter = document.getElementById('log-level-filter').value;
            const entries = document.querySelectorAll('.log-entry');
            
            entries.forEach(entry => {
                if (filter === 'all') {
                    entry.style.display = 'block';
                } else {
                    const isMatch = entry.classList.contains(`log-${filter}`);
                    entry.style.display = isMatch ? 'block' : 'none';
                }
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Last parsed management
        async function loadLastParsed() {
            try {
                const response = await fetch('/api/extract/last-parsed');
                if (response.ok) {
                    const data = await response.json();
                    const input = document.getElementById('last-parsed');
                    if (data.last_parsed) {
                        // Remove milliseconds and Z from the date string
                        let dateStr = data.last_parsed;
                        // Remove .000Z or .000 at the end
                        dateStr = dateStr.replace(/\.\d{3}Z?$/, '');
                        // If ends with Z, remove it
                        if (dateStr.endsWith('Z')) {
                            dateStr = dateStr.slice(0, -1);
                        }
                        // Set the value directly
                        input.value = dateStr;
                    }
                }
            } catch (error) {
                console.error('Failed to load last parsed date:', error);
            }
        }
        
        async function saveLastParsed() {
            const input = document.getElementById('last-parsed');
            const value = input.value;
            
            if (!value) {
                showNotification('Please select a date and time', 'error');
                return;
            }
            
            try {
                // Properly format the datetime for UTC
                let isoDate = value;
                // If no seconds present, add them
                if (!isoDate.includes(':') || isoDate.split(':').length === 2) {
                    isoDate += ':00';
                }
                // Add Z for UTC if not present
                if (!isoDate.endsWith('Z')) {
                    isoDate += 'Z';
                }
                
                const response = await fetch('/api/extract/last-parsed', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        last_parsed: isoDate
                    })
                });
                
                if (response.ok) {
                    showNotification('Last parsed date updated successfully', 'success');
                } else {
                    showNotification('Failed to update last parsed date', 'error');
                }
            } catch (error) {
                showNotification('Failed to save last parsed date', 'error');
            }
        }
        
        // Database Management Functions
        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/extract/articles/stats');
                if (response.ok) {
                    const stats = await response.json();
                    
                    // Update counts
                    document.getElementById('pending-count').textContent = stats.pending?.count || 0;
                    document.getElementById('parsed-count').textContent = stats.parsed?.count || 0;
                    document.getElementById('failed-count').textContent = stats.failed?.count || 0;
                }
            } catch (error) {
                console.error('Failed to load database stats:', error);
            }
        }
        
        async function cleanDatabase() {
            const selectEl = document.getElementById('clean-status');
            const status = selectEl.value;
            
            if (!status) {
                showNotification('Please select a status to clean', 'error');
                return;
            }
            
            const confirmMsg = `Are you sure you want to delete all ${status} articles? This will also delete their media files.`;
            if (!confirm(confirmMsg)) {
                return;
            }
            
            const btn = document.getElementById('clean-db-btn');
            btn.disabled = true;
            btn.textContent = 'Cleaning...';
            
            try {
                const response = await fetch(`/api/extract/articles/by-status/${status}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(
                        `Deleted ${result.deleted_articles} articles and ${result.deleted_media} media files`,
                        'success'
                    );
                    
                    // Reset selection
                    selectEl.value = '';
                    
                    // Reload stats
                    await loadDatabaseStats();
                } else {
                    showNotification('Failed to clean database', 'error');
                }
            } catch (error) {
                showNotification('Error cleaning database', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Clean Database';
                updateCleanButton();
            }
        }
        
        function updateCleanButton() {
            const selectEl = document.getElementById('clean-status');
            const btn = document.getElementById('clean-db-btn');
            btn.disabled = !selectEl.value;
        }
        
        // Last Parsed Management Functions
        async function refreshLastParsed() {
            try {
                console.log('Refreshing last parsed data...');
                const response = await fetch('/api/monitoring/sources/last-parsed');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Last parsed data received:', data);
                
                const tbody = document.getElementById('last-parsed-table-body');
                if (data.sources && data.sources.length > 0) {
                    tbody.innerHTML = data.sources.map(source => `
                        <tr class="border-b" style="border-color: oklch(var(--border));">
                            <td class="py-3 px-4">
                                <div class="font-medium">${source.source_name || source.source_id}</div>
                                <div class="text-sm" style="color: oklch(var(--muted-foreground));">${source.source_id}</div>
                            </td>
                            <td class="py-3 px-4">
                                <div class="text-sm" id="last-parsed-${source.source_id}">
                                    ${source.last_parsed ? new Date(source.last_parsed).toLocaleString() : 'Never'}
                                </div>
                            </td>
                            <td class="py-3 px-4">
                                <span class="px-2 py-1 text-xs rounded-full ${getLastParsedAgeClass(source.last_parsed)}">
                                    ${getLastParsedAgeText(source.last_parsed)}
                                </span>
                            </td>
                            <td class="py-3 px-4">
                                <button onclick="editLastParsed('${source.source_id}', '${source.last_parsed || ''}')" 
                                        class="btn-secondary px-2 py-1 text-xs mr-2">
                                    <i class="ri-edit-line"></i> Edit
                                </button>
                                <button onclick="resetLastParsed('${source.source_id}')" 
                                        class="btn-destructive px-2 py-1 text-xs">
                                    <i class="ri-refresh-line"></i> Reset
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-8" style="color: oklch(var(--muted-foreground));">
                                No sources found
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading last parsed data:', error);
                const tbody = document.getElementById('last-parsed-table-body');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-8 text-red-500">
                            Error loading sources: ${error.message}
                            <br><button onclick="refreshLastParsed()" class="btn-secondary px-3 py-2 text-sm mt-2">
                                <i class="ri-refresh-line"></i> Retry
                            </button>
                        </td>
                    </tr>
                `;
                showNotification('Failed to load last parsed data: ' + error.message, 'error');
            }
        }
        
        function getLastParsedAgeText(lastParsed) {
            if (!lastParsed) return 'Never';
            const now = new Date();
            const parsed = new Date(lastParsed);
            const diffHours = (now - parsed) / (1000 * 60 * 60);
            
            if (diffHours < 24) {
                return `${Math.round(diffHours)}h ago`;
            } else if (diffHours < 168) { // 7 days
                return `${Math.round(diffHours / 24)}d ago`;
            } else {
                return `${Math.round(diffHours / 168)}w ago`;
            }
        }
        
        function getLastParsedAgeClass(lastParsed) {
            if (!lastParsed) return 'bg-gray-100 text-gray-800';
            const now = new Date();
            const parsed = new Date(lastParsed);
            const diffHours = (now - parsed) / (1000 * 60 * 60);
            
            if (diffHours < 24) {
                return 'bg-green-100 text-green-800';
            } else if (diffHours < 168) { // 7 days
                return 'bg-yellow-100 text-yellow-800';
            } else {
                return 'bg-red-100 text-red-800';
            }
        }
        
        async function editLastParsed(sourceId, currentValue) {
            const newValue = prompt('⚠️ GLOBAL UPDATE\n\nThis will update the global last_parsed timestamp for ALL sources.\nEnter new timestamp (ISO format):', currentValue || new Date().toISOString());
            if (newValue && newValue !== currentValue) {
                try {
                    await axios.put(`/api/monitoring/sources/${sourceId}/last-parsed?last_parsed=${encodeURIComponent(newValue)}`);
                    showNotification(`Updated global last_parsed timestamp (affects all sources)`, 'success');
                    refreshLastParsed();
                } catch (error) {
                    console.error('Error updating global last parsed:', error);
                    showNotification('Failed to update global last parsed', 'error');
                }
            }
        }
        
        async function resetLastParsed(sourceId) {
            if (confirm('⚠️ GLOBAL RESET\n\nThis will reset the global last_parsed timestamp for ALL sources.\nThis will cause the parser to fetch articles from scratch.\n\nAre you sure?')) {
                try {
                    // Set to a very old date to effectively reset
                    const resetDate = '2020-01-01T00:00:00Z';
                    await axios.put(`/api/monitoring/sources/${sourceId}/last-parsed?last_parsed=${encodeURIComponent(resetDate)}`);
                    showNotification(`Reset global last_parsed timestamp (affects all sources)`, 'success');
                    refreshLastParsed();
                } catch (error) {
                    console.error('Error resetting global last parsed:', error);
                    showNotification('Failed to reset global last parsed', 'error');
                }
            }
        }

        // Removed duplicate clearLogs function - using the one defined above

        function toggleLogPause() {
            logsPaused = !logsPaused;
            const btn = document.getElementById('log-pause-btn');
            const icon = btn.querySelector('i');
            const text = btn.querySelector('span');
            
            if (logsPaused) {
                icon.className = 'ri-play-line';
                text.textContent = 'Resume';
            } else {
                icon.className = 'ri-pause-line';
                text.textContent = 'Pause';
            }
        }

        // RSS Functions
        async function loadRSSData() {
            console.log('Loading RSS data...');
            try {
                // Get RSS feeds data
                const response = await fetch('/api/rss/feeds');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                // Update summary statistics  
                const summaryElements = document.querySelectorAll('#rss-tab .text-3xl');
                if (summaryElements[0]) summaryElements[0].textContent = data.total_feeds || '0';
                if (summaryElements[1]) summaryElements[1].textContent = data.error_feeds || '0';
                
                // Get status for fetch time
                const statusResponse = await fetch('/api/rss/status');
                if (statusResponse.ok) {
                    const statusData = await statusResponse.json();
                    if (summaryElements[2]) summaryElements[2].textContent = Math.round(statusData.avg_fetch_time_ms || 0);
                }
                
                // Update table
                const tbody = document.querySelector('#rss-tab tbody');
                if (tbody && data.feeds && data.feeds.length > 0) {
                    tbody.innerHTML = data.feeds.map(feed => `
                        <tr class="border-b">
                            <td class="py-3 px-4">
                                <div class="font-medium">${feed.source_name}</div>
                            </td>
                            <td class="py-3 px-4 text-sm">${feed.articles_count || 0}</td>
                            <td class="py-3 px-4 text-sm">${feed.error_count || 0}</td>
                            <td class="py-3 px-4 text-sm">${Math.round(feed.pipeline_efficiency || 0)}%</td>
                            <td class="py-3 px-4 text-sm">${Math.round(feed.fetch_time_ms || 0)}ms</td>
                        </tr>
                    `).join('');
                } else if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No RSS feeds found</td></tr>';
                }
                
            } catch (error) {
                console.error('Error loading RSS data:', error);
                const tbody = document.querySelector('#rss-tab tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Error loading RSS feeds</td></tr>';
                }
            }
        }
        
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'healthy': return 'bg-green-100 text-green-800';
                case 'error': return 'bg-red-100 text-red-800';
                case 'timeout': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Never';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }
        
        async function refreshRSSFeeds() {
            showNotification('Refreshing RSS feeds...', 'success');
            await loadRSSData();
        }
        
        async function checkRSSFeed(sourceId) {
            try {
                showNotification(`Checking RSS feed for ${sourceId}...`, 'success');
                await axios.post(`/api/rss/feed/${sourceId}/check`);
                // Refresh after a short delay
                setTimeout(() => refreshRSSFeeds(), 2000);
            } catch (error) {
                console.error('Error checking RSS feed:', error);
                showNotification('Failed to check RSS feed', 'error');
            }
        }

        function refreshDashboard() {
            showNotification('Refreshing dashboard...', 'success');
            loadTabData(currentTab);
            updateConnectionStatus();
        }

        // Notification system
        function showNotification(message, type = 'success', duration = 3000) {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            const icon = type === 'success' ? 'ri-check-line' : 
                        type === 'error' ? 'ri-error-warning-line' : 
                        'ri-information-line';
            
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="${icon} text-lg"></i>
                    <span class="font-medium">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-auto">
                        <i class="ri-close-line"></i>
                    </button>
                </div>
            `;

            container.appendChild(notification);

            // Auto remove after duration
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, duration);
        }

        // Connection status
        function updateConnectionStatus(isConnected = null) {
            const indicator = document.getElementById('connection-indicator');
            const status = document.getElementById('connection-status');
            const lastUpdate = document.getElementById('last-update');

            // If no parameter provided, check if any WebSocket is connected
            if (isConnected === null) {
                isConnected = (logSocket && logSocket.readyState === WebSocket.OPEN) || 
                             (metricsSocket && metricsSocket.readyState === WebSocket.OPEN);
            }

            if (isConnected) {
                indicator.className = 'w-2 h-2 rounded-full status-connected';
                status.className = 'text-sm font-medium status-connected';
                status.textContent = 'Connected';
                lastUpdate.textContent = new Date().toLocaleTimeString();
            } else {
                indicator.className = 'w-2 h-2 rounded-full status-error';
                status.className = 'text-sm font-medium status-error';
                status.textContent = 'Disconnected';
            }
        }

        // Initialize dashboard
        function initializeDashboard() {
            updateConnectionStatus();
            switchTab('control');
            
            // Load saved logs from localStorage
            loadLogsFromStorage();
            
            // Initialize Extract button states
            updateExtractButtonStates();
            
            // Set up refresh interval - only for non-control tabs
            refreshInterval = setInterval(() => {
                if (!logsPaused && currentTab !== 'control') {
                    loadTabData(currentTab);
                }
                // Also refresh Extract button states every 30 seconds
                updateExtractButtonStates();
            }, 30000);
        }

        // Helper functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function getErrorLevelClass(level) {
            switch(level) {
                case 'CRITICAL': return 'bg-red-100 text-red-800';
                case 'ERROR': return 'bg-orange-100 text-orange-800';
                case 'WARNING': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        function getLogLevelClass(level) {
            switch(level) {
                case 'ERROR': return 'bg-red-100 text-red-800';
                case 'WARNING': return 'bg-yellow-100 text-yellow-800';
                case 'INFO': return 'bg-blue-100 text-blue-800';
                case 'DEBUG': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        async function killProcess(pid) {
            if (confirm(`Are you sure you want to kill process ${pid}?`)) {
                try {
                    const response = await fetch(`/api/memory/processes/${pid}/kill`, { method: 'POST' });
                    if (response.ok) {
                        showNotification(`Process ${pid} killed successfully`, 'success');
                        loadMemoryData();
                    } else {
                        throw new Error('Failed to kill process');
                    }
                } catch (error) {
                    showNotification(`Failed to kill process: ${error.message}`, 'error');
                }
            }
        }

        // Media viewing functions
        async function viewArticleMedia(articleId) {
            try {
                console.log('Loading media for article:', articleId);
                const response = await fetch(`/api/articles/${articleId}/media`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                showMediaModal(articleId, data.media_files || []);
            } catch (error) {
                console.error('Error loading media:', error);
                showNotification('Ошибка загрузки медиа: ' + error.message, 'error');
            }
        }
        
        function showMediaModal(articleId, mediaFiles) {
            const modalHTML = `
                <div id="media-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) closeMediaModal()">
                    <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-hidden">
                        <div class="p-6 border-b flex justify-between items-center">
                            <h2 class="text-xl font-bold">Media Files (${mediaFiles.length})</h2>
                            <button onclick="closeMediaModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            ${mediaFiles.length > 0 ? 
                                `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${mediaFiles.map(media => `
                                        <div class="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                                            <div class="flex items-center justify-between mb-3">
                                                <span class="px-2 py-1 text-xs rounded ${
                                                    media.type === 'image' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'
                                                }">
                                                    <i class="ri-${media.type === 'image' ? 'image' : 'video'}-line mr-1"></i>
                                                    ${media.type || 'Unknown'}
                                                </span>
                                                <span class="px-2 py-1 text-xs rounded ${
                                                    media.status === 'completed' ? 'bg-green-100 text-green-800' : 
                                                    media.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                                                    'bg-gray-100 text-gray-800'
                                                }">${media.status || 'unknown'}</span>
                                            </div>
                                            
                                            ${media.file_path && media.type === 'image' ? 
                                                (() => {
                                                    const mediaPath = media.file_path.startsWith('data/media/') ? media.file_path.replace('data/media/', '') : media.file_path.replace('media/', '');
                                                    return `<div class="mb-3 cursor-pointer" onclick="openImagePreview('${media.file_path}')">
                                                        <img src="/media/${mediaPath}" alt="Media preview" 
                                                             class="w-full h-32 object-cover rounded border hover:opacity-80 transition-opacity"
                                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                                        <div class="w-full h-32 bg-gray-100 rounded border flex items-center justify-center text-gray-500" style="display:none;">
                                                            <i class="ri-image-line text-2xl"></i>
                                                        </div>
                                                    </div>`;
                                                })() : 
                                                `<div class="mb-3 h-32 bg-gray-100 rounded border flex items-center justify-center text-gray-500">
                                                    <i class="ri-${media.type === 'video' ? 'video' : 'file'}-line text-2xl"></i>
                                                </div>`
                                            }
                                            
                                            <div class="space-y-2 text-sm">
                                                ${media.url ? `<div class="text-blue-600 hover:underline"><a href="${media.url}" target="_blank" class="truncate block">🌐 Original URL</a></div>` : ''}
                                                ${media.file_path ? (() => {
                                                    const mediaPath = media.file_path.startsWith('data/media/') ? media.file_path.replace('data/media/', '') : media.file_path.replace('media/', '');
                                                    return `<div class="text-green-600 hover:underline"><a href="/media/${mediaPath}" target="_blank" class="truncate block">💾 Local File</a></div>`;
                                                })() : ''}
                                                ${media.file_path ? `<div class="text-gray-600">Path: ${media.file_path}</div>` : ''}
                                                ${media.width && media.height ? `<div class="text-gray-500">${media.width} × ${media.height}px</div>` : ''}
                                                ${media.file_size ? `<div class="text-gray-500">${formatFileSize(media.file_size)}</div>` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>` :
                                '<div class="text-center py-8 text-gray-500">Медиафайлы не найдены</div>'
                            }
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function closeMediaModal() {
            const modal = document.getElementById('media-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Universal function to handle both old and new media path formats
        function getMediaPath(filePath) {
            if (filePath.startsWith('data/media/')) {
                return filePath.replace('data/media/', '');
            } else if (filePath.startsWith('media/')) {
                return filePath.replace('media/', '');
            }
            return filePath;
        }

        function openImagePreview(imagePath) {
            const mediaPath = getMediaPath(imagePath);
            const previewHTML = `
                <div id="image-preview" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[60] p-4" onclick="if(event.target === this) closeImagePreview()">
                    <div class="relative max-w-full max-h-full">
                        <button onclick="closeImagePreview()" class="absolute top-4 right-4 text-white text-2xl bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-75">×</button>
                        <img src="/media/${mediaPath}" alt="Preview" class="max-w-full max-h-full object-contain">
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', previewHTML);
        }
        
        function closeImagePreview() {
            const preview = document.getElementById('image-preview');
            if (preview) {
                preview.remove();
            }
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown size';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            
            // Add keyboard shortcuts for pagination
            document.addEventListener('keydown', function(event) {
                // Arrow keys for pagination when on articles tab
                if (currentTab === 'articles' && !event.target.matches('input, textarea, select')) {
                    if (event.key === 'ArrowLeft' && currentPage > 1) {
                        event.preventDefault();
                        loadArticlesPage('prev');
                    } else if (event.key === 'ArrowRight' && currentPage < totalPages) {
                        event.preventDefault();
                        loadArticlesPage('next');
                    }
                }
            });
            
            // Error management functions
            window.copyAllErrorsForDebug = async function() {
                try {
                    if (!currentErrorsData || !currentErrorsData.errors || currentErrorsData.errors.length === 0) {
                        showNotification('No errors to copy', 'warning');
                        return;
                    }
                    
                    const debugText = `AI News Parser Error Report
Generated: ${new Date().toISOString()}
Total Errors: ${currentErrorsData.total_errors}
Sources with Errors: ${currentErrorsData.sources_with_errors}

=== ERRORS ===
${currentErrorsData.errors.map(error => `
[${error.timestamp}] ${error.level} - ${error.error_type || 'Unknown'}
Source: ${error.source_id || 'Unknown'}
Message: ${error.error_message}
${error.stack_trace ? 'Stack:\n' + error.stack_trace : ''}
Context: ${JSON.stringify(error.context, null, 2)}
---`).join('\n')}`;
                    
                    await navigator.clipboard.writeText(debugText);
                    showNotification('Error report copied to clipboard', 'success');
                } catch (error) {
                    console.error('Failed to copy errors:', error);
                    showNotification('Failed to copy errors', 'error');
                }
            };
            
            window.exportErrorsAsText = async function() {
                try {
                    if (!currentErrorsData || !currentErrorsData.errors || currentErrorsData.errors.length === 0) {
                        showNotification('No errors to export', 'warning');
                        return;
                    }
                    
                    const exportText = `AI News Parser Error Report
Generated: ${new Date().toISOString()}
Total Errors: ${currentErrorsData.total_errors}
Sources with Errors: ${currentErrorsData.sources_with_errors}

=== ERRORS ===
${currentErrorsData.errors.map(error => `
[${error.timestamp}] ${error.level} - ${error.error_type || 'Unknown'}
Source: ${error.source_id || 'Unknown'}
Message: ${error.error_message}
${error.stack_trace ? 'Stack:\n' + error.stack_trace : ''}
---`).join('\n')}`;
                    
                    // Create and download file
                    const blob = new Blob([exportText], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ai_news_errors_${new Date().toISOString().slice(0,10)}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('Error report downloaded', 'success');
                } catch (error) {
                    console.error('Failed to export errors:', error);
                    showNotification('Failed to export errors', 'error');
                }
            };
            
            window.clearErrorsList = async function() {
                try {
                    const response = await fetch('/api/errors/clear', {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to clear errors');
                    }
                    
                    // Clear the displayed data
                    currentErrorsData = null;
                    
                    // Clear the UI
                    const errorContainer = document.getElementById('errors-list');
                    if (errorContainer) {
                        errorContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No errors found</div>';
                    }
                    
                    // Update stats to 0
                    const stats = document.querySelectorAll('#errors-tab .text-3xl');
                    if (stats[0]) stats[0].textContent = '0';
                    if (stats[1]) stats[1].textContent = '0';
                    
                    showNotification('Error list cleared', 'success');
                } catch (error) {
                    console.error('Failed to clear errors:', error);
                    showNotification('Failed to clear errors', 'error');
                }
            };
        });
    </script>

    <!-- Complete integrated monitoring.js -->
    <!-- TEMPORARILY DISABLED: monitoring.js conflicts with index.html functions -->
    <!-- <script src="/static/monitoring.js"></script> -->
    
    <script src="/static/js/log-filter.js"></script>
    
    <script>
        // WebSocket for system metrics updates
        let metricsSocket = null;
        
        function connectMetricsWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            metricsSocket = new WebSocket(wsUrl);
            
            metricsSocket.onopen = () => {
                console.log('Metrics WebSocket connected');
                updateConnectionStatus(true);
            };
            
            metricsSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    
                    
                    // Handle system metrics
                    if (data.type === 'system_metrics') {
                        updateSystemInfo(data);
                    }
                    
                    // Handle process status changes - auto-refresh Database Management
                    if (data.type === 'process_status_change') {
                        console.log('Process status changed:', data);
                        
                        // Refresh database stats when any phase completes
                        if (data.status === 'stopped' || data.status === 'parsed') {
                            setTimeout(() => {
                                console.log('Auto-refreshing Database Management after process completion');
                                loadDatabaseStats();
                            }, 2000); // Small delay to ensure database is updated
                        }
                    }
                } catch (error) {
                    console.error('Error parsing metrics message:', error);
                }
            };
            
            metricsSocket.onclose = () => {
                console.log('Metrics WebSocket disconnected');
                updateConnectionStatus(false);
                // Reconnect after 3 seconds
                setTimeout(connectMetricsWebSocket, 3000);
            };
            
            metricsSocket.onerror = (error) => {
                console.error('Metrics WebSocket error:', error);
            };
        }
        
        function updateSystemInfo(data) {
            // Update last update time
            const lastUpdate = document.getElementById('last-update');
            if (lastUpdate) {
                lastUpdate.textContent = new Date().toLocaleTimeString();
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Connect to metrics WebSocket
            connectMetricsWebSocket();
            
            // Initialize database management
            loadDatabaseStats();
            
            // Set up clean button state handler
            const cleanStatusSelect = document.getElementById('clean-status');
            if (cleanStatusSelect) {
                cleanStatusSelect.addEventListener('change', updateCleanButton);
            }
            
            // Refresh database stats every 30 seconds
            setInterval(loadDatabaseStats, 30000);
        });
    </script>
</body>
</html>